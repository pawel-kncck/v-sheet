<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>v-sheet</title>
    <link rel="stylesheet" href="css/spreadsheet.css" />
  </head>
  <body>
    <!-- Formula bar container -->
    <div id="formula-bar-container">
      <!-- File selector dropdown -->
      <div id="file-selector-wrapper">
        <button id="file-selector-button" class="file-selector-button">
          <span id="current-file-name">Loading...</span>
          <svg class="dropdown-arrow" width="10" height="6" viewBox="0 0 10 6">
            <path
              d="M0 0 L5 5 L10 0"
              stroke="currentColor"
              stroke-width="1.5"
              fill="none"
            />
          </svg>
        </button>
        <div id="file-dropdown" class="file-dropdown hidden">
          <div class="file-dropdown-header">
            <input
              type="text"
              id="file-search"
              placeholder="Search files..."
              class="file-search-input"
            />
          </div>
          <div class="file-dropdown-actions">
            <button id="new-file-btn" class="dropdown-action-btn">
              <svg width="14" height="14" viewBox="0 0 14 14">
                <path
                  d="M7 2 L7 12 M2 7 L12 7"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
              </svg>
              New File
            </button>
            <button id="rename-file-btn" class="dropdown-action-btn">
              <svg width="14" height="14" viewBox="0 0 14 14">
                <path
                  d="M2 12 L12 12 M7 2 L10 5 L6 9 L2 10 L3 6 Z"
                  stroke="currentColor"
                  stroke-width="1"
                  fill="none"
                />
              </svg>
              Rename
            </button>
            <button id="delete-file-btn" class="dropdown-action-btn delete">
              <svg width="14" height="14" viewBox="0 0 14 14">
                <path
                  d="M3 4 L11 4 M4 4 L4 2 L10 2 L10 4 M5 6 L5 10 M9 6 L9 10 M4 4 L4 12 L10 12 L10 4"
                  stroke="currentColor"
                  stroke-width="1"
                  fill="none"
                />
              </svg>
              Delete
            </button>
          </div>
          <div id="file-list" class="file-list">
            <!-- File items will be dynamically added here -->
          </div>
        </div>
      </div>

      <!-- Cell reference display -->
      <div id="cell-reference" class="cell-reference">A1</div>

      <!-- Function symbol -->
      <div class="formula-function-symbol">
        <span>fx</span>
      </div>

      <!-- Formula input -->
      <input
        type="text"
        id="formula-input"
        class="formula-input"
        placeholder="Enter formula or value..."
      />
    </div>

    <!-- Main spreadsheet container -->
    <div id="spreadsheet-container">
      <input
        type="text"
        id="cell-editor"
        style="position: absolute; display: none"
      />
      <div id="corner-cell" class="header-cell"></div>
      <div id="column-headers"></div>
      <div id="row-headers"></div>
      <div id="cell-grid"></div>
    </div>

    <script type="module">
      // Import classes as ES6 modules
      import { FileManager } from './js/file-manager.js';
      import { FormulaBar } from './js/formula-bar.js';
      import { Spreadsheet } from './js/spreadsheet.js';

      let fileManager;
      let formulaBar;
      let spreadsheet;
      let formulaWorker;

      // Initialize everything when page loads
      window.addEventListener('DOMContentLoaded', async () => {
        try {
          // --- 2. Create the Formula Worker ---
          formulaWorker = new Worker('js/engine/formula-worker.js', {
            type: 'module',
          });

          // Add error handler IMMEDIATELY after creation
          formulaWorker.onerror = (error) => {
            console.error('âŒ Worker Error:', error);
            console.error('Message:', error.message);
            console.error('Filename:', error.filename);
            console.error('Line:', error.lineno);
            alert('Worker failed to load: ' + error.message);
          };

          // Listen for the worker to tell us it's ready
          formulaWorker.onmessage = (event) => {
            if (event.data.type === 'ready') {
              console.log('Formula Worker is ready.');
              // Now we can continue with file loading
              initializeApplication();
            } else if (event.data.type === 'error') {
              console.error(
                'Worker initialization error:',
                event.data.payload.message
              );
              alert('Critical: Formula engine failed to start.');
            }
          };

          // --- 3. Move the rest of the init logic into a function ---
          // We can't load the file until the worker is ready.
          async function initializeApplication() {
            // Create instances, passing the worker to the spreadsheet
            spreadsheet = new Spreadsheet(
              'spreadsheet-container',
              formulaWorker
            );
            fileManager = new FileManager();

            // Initialize file manager first
            const initialized = await fileManager.initialize();

            if (initialized) {
              // Only create formula bar after file manager is ready
              formulaBar = new FormulaBar(fileManager, spreadsheet);

              // Connect components
              spreadsheet.setFileManager(fileManager);
              spreadsheet.setFormulaBar(formulaBar);

              // Tell the spreadsheet to set up its worker listeners
              spreadsheet.setFormulaWorker(formulaWorker);

              // Load the spreadsheet data from the current file
              const fileData = fileManager.getCurrentFileData();
              if (fileData) {
                spreadsheet.loadFromFile(fileData);
              }

              console.log('Spreadsheet application initialized successfully');
            } else {
              console.error(
                'Failed to initialize file manager - application cannot start'
              );
              alert(
                'Failed to connect to the server. Please ensure the Flask server is running.'
              );
            }
          }
        } catch (error) {
          console.error('Failed to initialize spreadsheet:', error);
          alert(
            'Application initialization failed. Check the console for details.'
          );
        }
      });
    </script>
  </body>
</html>
